#!/bin/bash
# Consolidate: Crystallize recurring patterns into skills (~5% chance)
#
# Trigger: Stop hook, gated by random chance
# Input: ~/.claude/rem/patterns/<project>/ (user-scoped, ephemeral)
# Output: .claude/skills/{domain}/ (project-scoped, durable)

# Random gate
[ $((RANDOM % 20)) -eq 0 ] || exit 0

# Compute project-scoped paths
PROJECT_PATH=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
PROJECT_SLUG=$(echo "$PROJECT_PATH" | tr '/.' '-')
PATTERNS_DIR="$HOME/.claude/rem/patterns/$PROJECT_SLUG"
MEMORY_DIR="$HOME/.claude/projects/$PROJECT_SLUG/memory"

# Bail if no patterns directory
[ -d "$PATTERNS_DIR" ] || exit 0

# Pre-filter: count entries per domain, check for stale entries
# Avoids expensive model call when there's nothing to consolidate
HAS_CANDIDATES=false
HAS_STALE=false
CUTOFF=$(date -v-30d +%Y-%m-%d 2>/dev/null || date -d "30 days ago" +%Y-%m-%d)

for f in "$PATTERNS_DIR"/*.md; do
  [ -f "$f" ] && [ "$(basename "$f")" != "INDEX.md" ] || continue

  # Count entries (each has 2 --- lines for frontmatter)
  n=$(grep -c '^---$' "$f" 2>/dev/null || echo 0)
  entries=$((n / 2))
  [ "$entries" -ge 3 ] && HAS_CANDIDATES=true

  # Check for stale entries
  while IFS= read -r d; do
    d="${d#date: }"
    [[ "$d" < "$CUTOFF" ]] && HAS_STALE=true && break
  done < <(grep '^date: ' "$f" 2>/dev/null)

  $HAS_CANDIDATES && $HAS_STALE && break
done

# Bail if nothing to do
$HAS_CANDIDATES || $HAS_STALE || exit 0

claude --print --dangerously-skip-permissions \
  "Consolidate patterns from $PATTERNS_DIR/:

   1. Scan all .md files (except INDEX.md) for recurring learnings (3+ similar observations)
   2. Crystallize into project skills or CLAUDE.md
   3. Prune entries with date older than $CUTOFF
   4. Remove patterns that were just consolidated into skills

   PLACEMENT GUIDANCE:
   - CLAUDE.md: Rules that apply to EVERY task in this codebase (style, conventions,
     return types, error handling, project structure). These burn context tokens every
     turn — only universal rules justify that cost.
   - .claude/skills/{domain}/: Knowledge for a specific area (framework workarounds,
     library gotchas, API patterns). Loaded on demand, not always.

   SOURCE CITATIONS: When writing skills, include a provenance comment:
   <!-- consolidated from: {domain}.md {date1}, {date2}, {date3} -->

   MEMORY.md INTEGRATION:
   - Write a one-liner summary of each new skill to $MEMORY_DIR/MEMORY.md (mkdir -p the directory)
   - Scan $MEMORY_DIR/MEMORY.md for entries that duplicate knowledge now in .claude/skills/ and remove them
   - Keep MEMORY.md entries minimal — just a reference, not a copy

   Constraints:
   - Skills go in project-scoped .claude/skills/
   - Keep concise
   - Preserve entries that are < 30 days old and haven't been consolidated"
