#!/bin/bash
# Encode: Extract patterns from conversation before context compaction
#
# Triggers: PreCompact, SessionEnd (on clear), Stop (via encode-opportunistic)
# Output: YAML-frontmatter pattern entries in ~/.claude/rem/patterns/<project>/

# Compute project-scoped paths
PROJECT_PATH=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
PROJECT_SLUG=$(echo "$PROJECT_PATH" | tr '/.' '-')
PATTERNS_DIR="$HOME/.claude/rem/patterns/$PROJECT_SLUG"
mkdir -p "$PATTERNS_DIR"

TODAY=$(date +%Y-%m-%d)

claude --print --dangerously-skip-permissions --model sonnet \
  "Review this session transcript for patterns worth remembering:
   - debugging with unclear root causes
   - tool failures and their resolutions
   - framework/library workarounds
   - undocumented gotchas
   - codebase conventions
   - user preferences
   - brand voice/messaging
   - effective approaches
   - architectural decisions

   If any found, use Bash to append to $PATTERNS_DIR/{domain}.md

   Format each entry as a YAML frontmatter block followed by content:

   ---
   domain: {domain}
   date: $TODAY
   tags: [relevant, tags, for, this, pattern]
   ---
   ### Title
   - **Observation**: What was learned
   - **Details**: Specific details
   - **Context**: When/where this applies

   CONTRADICTION CHECK: First read existing patterns in $PATTERNS_DIR/.
   If the transcript contradicts an existing pattern, update or remove the stale entry.

   Skip if nothing notable.

   $ARGUMENTS"

# Regenerate lightweight index for read-before-act
{
  echo "# Recent Patterns"
  echo ""
  echo "_Auto-generated by rem-sleep. Check domain files for full details._"
  echo ""
  for f in "$PATTERNS_DIR"/*.md; do
    [ -f "$f" ] && [ "$(basename "$f")" != "INDEX.md" ] || continue
    domain=$(basename "$f" .md)
    grep '^### ' "$f" 2>/dev/null | tail -5 | while IFS= read -r title; do
      echo "- **$domain**: ${title#### }"
    done
  done
} > "$PATTERNS_DIR/INDEX.md"
